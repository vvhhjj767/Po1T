<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO1 NEWSCAST - ELECTION SYSTEM</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600;700&family=Chakra+Petch:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { 
            --bg-dark: #050505; 
            --glass: rgba(15, 23, 42, 0.9); 
            --glass-border: rgba(255,255,255,0.1);
            --neon-blue: #3b82f6; 
            --neon-gold: #fbbf24; 
        }
        
        body { 
            font-family: 'Anuphan', sans-serif; 
            background-color: var(--bg-dark); 
            color: white; 
            overflow: hidden; 
            margin: 0;
        }
        
        .font-tech { font-family: 'Chakra Petch', sans-serif; }
        
        /* Glassmorphism Utilities */
        .glass-panel { 
            background: var(--glass); 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.6); 
            backdrop-filter: blur(12px);
        }
        
        /* Lower Third / News Bar Style */
        .news-bar-bg {
            background: linear-gradient(90deg, #0f172a 0%, #020617 100%);
            border-top: 3px solid var(--neon-gold);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }

        /* Animations */
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scanline::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.05) 50%, transparent 100%);
            animation: scanline 4s linear infinite;
            pointer-events: none;
        }

        /* Ticker Animation */
        .ticker-wrap { width: 100%; overflow: hidden; white-space: nowrap; position: relative; }
        .ticker-track { display: inline-block; white-space: nowrap; padding-left: 100%; animation: ticker 35s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* Transparent Mode (OBS) */
        body.transparent .bg-main { background: transparent !important; }
        body.transparent .obs-hide { display: none !important; }
        body.transparent .scene-bg { display: none !important; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>

<div id="app" class="w-full h-full relative"></div>

<script>
    // ==========================================
    // 1. CONFIGURATION & STATE MANAGEMENT
    // ==========================================
    const STORAGE_KEY = 'PO1_NEWSCAST_DB_V2';
    const LIMITS = { zone: 400, list: 100 };

    const DEFAULT_DATA = {
        parties: [
            { id: 'p1', name: '‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', color: '#FF9100', zone: 120, list: 30 },
            { id: 'p2', name: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢', color: '#E60000', zone: 100, list: 25 },
            { id: 'p3', name: '‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢', color: '#0033CC', zone: 50, list: 10 },
            { id: 'p4', name: '‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥', color: '#2C3E50', zone: 20, list: 5 },
            { id: 'p5', name: '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå', color: '#00AEF0', zone: 10, list: 2 },
            { id: 'p6', name: '‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤', color: '#eab308', zone: 5, list: 1 }
        ],
        scene: 'newsbar', 
        ticker: 'üî¥ ‡πÄ‡∏Å‡∏≤‡∏∞‡∏ï‡∏¥‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 : ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏î‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô... | ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏Å‡∏¥‡∏ô 75% | ‡∏Å‡∏Å‡∏ï. ‡∏Ñ‡∏≤‡∏î‡∏£‡∏π‡πâ‡∏ú‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 4 ‡∏ó‡∏∏‡πà‡∏°',
        bg: 'dark'
    };

    function loadState() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(DEFAULT_DATA));
        } catch (e) {
            console.error("State Load Error", e);
            return JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
    }

    function saveState(s) { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); 
    }

    function resetState() {
        if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô?')) {
            saveState(DEFAULT_DATA);
            location.reload();
        }
    }

    let state = loadState();
    let chartInstance = null;

    // ==========================================
    // 2. ROUTER & NAVIGATION
    // ==========================================
    const app = document.getElementById('app');
    const params = new URLSearchParams(window.location.search);
    const mode = params.get('mode');

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    window.openWindow = function(modeName) {
        if(modeName === 'onair') {
            // ‡πÄ‡∏õ‡∏¥‡∏î Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö On-Air
            window.open('?mode=onair', 'onair_win', 'width=1280,height=720,menubar=no,toolbar=no,location=no,status=no');
        } else {
            // ‡πÄ‡∏õ‡∏¥‡∏î Control ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            window.location.href = '?mode=' + modeName;
        }
    };

    if (!mode) renderMenu();
    else if (mode === 'control') initControl();
    else if (mode === 'onair') initOnAir();

    // ==========================================
    // 3. MAIN MENU
    // ==========================================
    function renderMenu() {
        app.innerHTML = `
            <div class="h-screen w-screen flex items-center justify-center bg-black bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-[#0a0a0a] to-black">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-20"></div>
                
                <div class="glass-panel p-16 rounded-3xl text-center max-w-4xl w-full border-t-4 border-yellow-500 shadow-[0_0_100px_rgba(234,179,8,0.1)] relative z-10">
                    <div class="inline-block mb-6 px-4 py-1 rounded-full bg-yellow-500/10 border border-yellow-500/30 text-yellow-500 text-xs font-bold tracking-widest uppercase">
                        Election Broadcast System v2.1
                    </div>
                    <h1 class="text-8xl font-tech font-bold text-white mb-2 tracking-tight">PO1 <span class="text-yellow-500">NEWS</span></h1>
                    <p class="text-slate-400 mb-16 text-lg tracking-[0.3em] font-light">REAL-TIME GRAPHICS ENGINE</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-2xl mx-auto">
                        <button onclick="openWindow('control')" class="group h-48 bg-slate-900/50 border border-slate-700 rounded-2xl hover:bg-yellow-600 hover:border-yellow-400 hover:text-black transition-all duration-300 flex flex-col items-center justify-center relative overflow-hidden">
                            <div class="absolute inset-0 bg-yellow-500/10 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
                            <i class="fa-solid fa-sliders text-6xl mb-6 group-hover:scale-110 transition-transform relative z-10"></i>
                            <span class="font-bold text-xl tracking-widest relative z-10">CONTROL ROOM</span>
                            <span class="text-xs mt-2 text-slate-500 group-hover:text-black/70 relative z-10">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ã‡∏µ‡∏ô (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ)</span>
                        </button>
                        
                        <button onclick="openWindow('onair')" class="group h-48 bg-slate-900/50 border border-slate-700 rounded-2xl hover:bg-blue-600 hover:border-blue-400 hover:text-white transition-all duration-300 flex flex-col items-center justify-center relative overflow-hidden">
                            <div class="absolute inset-0 bg-blue-500/10 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
                            <i class="fa-solid fa-tv text-6xl mb-6 group-hover:scale-110 transition-transform relative z-10"></i>
                            <span class="font-bold text-xl tracking-widest relative z-10">ON-AIR SCREEN</span>
                            <span class="text-xs mt-2 text-slate-500 group-hover:text-white/70 relative z-10">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OBS</span>
                        </button>
                    </div>
                    <div class="mt-8 text-xs text-slate-600">
                        *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Control Room ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î On-Air Screen ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    </div>
                </div>
            </div>`;
    }

    // ==========================================
    // 4. CONTROL ROOM (BACKEND)
    // ==========================================
    function initControl() {
        document.title = "Control Room - PO1 News";
        state = loadState();

        function renderUI() {
            const totalZone = state.parties.reduce((s, p) => s + p.zone, 0);
            const totalList = state.parties.reduce((s, p) => s + p.list, 0);
            const totalSeats = totalZone + totalList;

            const scenes = [
                {id:'newsbar', icon:'fa-minus', label:'News Bar (L3)', desc:'‡πÅ‡∏ñ‡∏ö‡∏•‡πà‡∏≤‡∏á (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏†‡∏≤‡∏û)'},
                {id:'dashboard', icon:'fa-chart-simple', label:'Dashboard', desc:'‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (Full Screen)'},
                {id:'battle', icon:'fa-hand-fist', label:'Battle Gauge', desc:'‡∏ß‡∏±‡∏î‡∏û‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏• vs ‡∏ù‡πà‡∏≤‡∏¢‡∏Ñ‡πâ‡∏≤‡∏ô'},
                {id:'parliament', icon:'fa-users-rectangle', label:'Parliament', desc:'‡∏ú‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏†‡∏≤ 500 ‡∏Ñ‡∏ô'},
                {id:'chart', icon:'fa-chart-pie', label:'Donut Chart', desc:'‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ'},
                {id:'winner', icon:'fa-trophy', label:'Winner', desc:'‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ (‡∏°‡∏µ‡∏û‡∏•‡∏∏)'}
            ];

            app.innerHTML = `
                <div class="flex h-screen bg-[#050505] text-white font-sans text-sm overflow-hidden">
                    <div class="w-80 bg-[#0f172a] border-r border-slate-800 flex flex-col z-20 shadow-2xl">
                        <div class="p-5 border-b border-slate-800 bg-[#020617]">
                            <h2 class="font-bold text-lg text-white tracking-wide flex items-center gap-3">
                                <span class="relative flex h-3 w-3">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                </span>
                                LIVE CONTROL
                            </h2>
                            <div class="text-[10px] text-slate-500 mt-1">Status: Active | Auto-Save: ON</div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                            <div class="text-[10px] text-slate-400 font-bold uppercase px-2 mb-1 tracking-wider">Scene Selection</div>
                            ${scenes.map(s => `
                                <button onclick="setScene('${s.id}')" class="w-full text-left p-3 rounded-lg border transition-all duration-200 group relative overflow-hidden ${state.scene===s.id ? 'bg-blue-600 border-blue-400 text-white shadow-lg' : 'bg-slate-800/50 border-slate-700/50 text-slate-400 hover:bg-slate-800 hover:text-slate-200'}">
                                    <div class="font-bold text-sm flex items-center gap-3 relative z-10">
                                        <div class="w-8 h-8 rounded flex items-center justify-center bg-black/20">
                                            <i class="fa-solid ${s.icon}"></i>
                                        </div>
                                        <div>
                                            <div>${s.label}</div>
                                            <div class="text-[10px] opacity-70 font-normal">${s.desc}</div>
                                        </div>
                                    </div>
                                    ${state.scene===s.id ? '<div class="absolute right-3 top-3 w-2 h-2 bg-white rounded-full shadow-[0_0_10px_white] animate-pulse"></div>' : ''}
                                </button>
                            `).join('')}
                        </div>

                        <div class="p-4 border-t border-slate-800 bg-[#0f172a]">
                            <div class="text-[10px] text-slate-400 font-bold uppercase mb-2">Ticker Control</div>
                            <div class="flex gap-2 mb-4">
                                <input id="ticker-input" class="flex-1 bg-black/50 border border-slate-700 rounded px-3 py-2 text-xs text-white focus:border-blue-500 outline-none transition" value="${state.ticker}" placeholder="Running Text...">
                                <button id="ticker-btn" onclick="pushTicker()" class="bg-blue-600 px-3 rounded font-bold text-xs hover:bg-blue-500 text-white transition"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Background</div>
                                    <select onchange="setBg(this.value)" class="w-full bg-black/50 border border-slate-700 rounded p-2 text-xs text-white outline-none">
                                        <option value="dark" ${state.bg==='dark'?'selected':''}>Dark Studio</option>
                                        <option value="transparent" ${state.bg==='transparent'?'selected':''}>Transparent (OBS)</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">System</div>
                                    <button onclick="resetState()" class="w-full bg-red-900/30 border border-red-900/50 text-red-400 hover:bg-red-900/50 rounded p-2 text-xs font-bold transition">
                                        <i class="fa-solid fa-rotate-left mr-1"></i> RESET
                                    </button>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-800">
                                <button onclick="window.openWindow('onair')" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded text-xs flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-external-link-alt"></i> Open On-Air Window
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 p-8 overflow-y-auto bg-[#0a0a0a] relative">
                        <div class="max-w-5xl mx-auto pb-20">
                            <div class="grid grid-cols-3 gap-4 mb-8">
                                <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl flex items-center justify-between shadow-lg">
                                    <div>
                                        <div class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">Total Seats</div>
                                        <div class="text-3xl font-tech font-bold text-white mt-1">${totalSeats} <span class="text-sm text-slate-600">/ 500</span></div>
                                    </div>
                                    <div class="h-10 w-10 rounded-full bg-slate-800 flex items-center justify-center text-slate-500">
                                        <i class="fa-solid fa-landmark"></i>
                                    </div>
                                </div>
                                <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl flex items-center justify-between shadow-lg relative overflow-hidden">
                                    <div class="absolute bottom-0 left-0 h-1 bg-blue-500 transition-all" style="width:${(totalZone/LIMITS.zone)*100}%"></div>
                                    <div>
                                        <div class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">Zone Quota</div>
                                        <div class="text-3xl font-tech font-bold ${totalZone >= LIMITS.zone ? 'text-red-400' : 'text-blue-400'} mt-1">
                                            ${totalZone} <span class="text-sm text-slate-600">/ ${LIMITS.zone}</span>
                                        </div>
                                    </div>
                                    <div class="h-10 w-10 rounded-full bg-slate-800 flex items-center justify-center text-blue-500">
                                        <i class="fa-solid fa-map-location-dot"></i>
                                    </div>
                                </div>
                                <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl flex items-center justify-between shadow-lg relative overflow-hidden">
                                    <div class="absolute bottom-0 left-0 h-1 bg-green-500 transition-all" style="width:${(totalList/LIMITS.list)*100}%"></div>
                                    <div>
                                        <div class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">List Quota</div>
                                        <div class="text-3xl font-tech font-bold ${totalList >= LIMITS.list ? 'text-red-400' : 'text-green-400'} mt-1">
                                            ${totalList} <span class="text-sm text-slate-600">/ ${LIMITS.list}</span>
                                        </div>
                                    </div>
                                    <div class="h-10 w-10 rounded-full bg-slate-800 flex items-center justify-center text-green-500">
                                        <i class="fa-solid fa-list-ol"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                ${state.parties.map((p, i) => `
                                    <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-800 hover:border-slate-600 hover:bg-slate-900/80 transition-all flex items-center gap-6 group relative">
                                        <div class="flex items-center gap-4 w-[35%]">
                                            <div class="relative w-12 h-12 shrink-0">
                                                <input type="color" value="${p.color}" onchange="updateVal(${i}, 'color', this.value)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                                <div class="w-full h-full rounded-lg shadow-sm" style="background:${p.color}"></div>
                                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none text-white/50 text-xs"><i class="fa-solid fa-pen"></i></div>
                                            </div>
                                            <div class="w-full">
                                                <div class="text-[9px] text-slate-500 uppercase font-bold">Party Name</div>
                                                <input type="text" value="${p.name}" oninput="updateVal(${i}, 'name', this.value)" class="bg-transparent font-bold text-lg w-full focus:outline-none border-b border-transparent focus:border-slate-500 pb-1 transition-colors text-white placeholder-slate-700">
                                            </div>
                                        </div>
                                        
                                        <div class="flex-1 grid grid-cols-2 gap-4">
                                            <div class="bg-black/40 px-3 py-2 rounded-lg flex items-center justify-between border border-slate-800 group-hover:border-slate-700 transition">
                                                <button onclick="adj(${i}, 'zone', -1)" class="w-6 h-6 rounded bg-slate-800 hover:bg-red-500/20 hover:text-red-500 text-slate-400 transition flex items-center justify-center"><i class="fa-solid fa-minus text-[10px]"></i></button>
                                                <div class="text-center">
                                                    <div class="text-[9px] text-slate-500 uppercase tracking-wider">ZONE</div>
                                                    <div class="font-tech text-xl font-bold text-white leading-none mt-1">${p.zone}</div>
                                                </div>
                                                <button onclick="adj(${i}, 'zone', 1)" class="w-6 h-6 rounded bg-slate-800 hover:bg-green-500/20 hover:text-green-500 text-slate-400 transition flex items-center justify-center" ${totalZone >= LIMITS.zone ? 'disabled' : ''}><i class="fa-solid fa-plus text-[10px]"></i></button>
                                            </div>
                                            <div class="bg-black/40 px-3 py-2 rounded-lg flex items-center justify-between border border-slate-800 group-hover:border-slate-700 transition">
                                                <button onclick="adj(${i}, 'list', -1)" class="w-6 h-6 rounded bg-slate-800 hover:bg-red-500/20 hover:text-red-500 text-slate-400 transition flex items-center justify-center"><i class="fa-solid fa-minus text-[10px]"></i></button>
                                                <div class="text-center">
                                                    <div class="text-[9px] text-slate-500 uppercase tracking-wider">LIST</div>
                                                    <div class="font-tech text-xl font-bold text-white leading-none mt-1">${p.list}</div>
                                                </div>
                                                <button onclick="adj(${i}, 'list', 1)" class="w-6 h-6 rounded bg-slate-800 hover:bg-green-500/20 hover:text-green-500 text-slate-400 transition flex items-center justify-center" ${totalList >= LIMITS.list ? 'disabled' : ''}><i class="fa-solid fa-plus text-[10px]"></i></button>
                                            </div>
                                        </div>

                                        <div class="w-20 text-center border-l border-slate-800 pl-4">
                                            <div class="text-[9px] text-slate-500 uppercase font-bold">TOTAL</div>
                                            <div class="text-2xl font-tech font-bold text-white" style="color:${p.color}">${p.zone+p.list}</div>
                                        </div>
                                        
                                        <button onclick="removeParty(${i})" class="w-8 h-8 rounded-full hover:bg-red-500/10 text-slate-600 hover:text-red-500 transition flex items-center justify-center">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <button onclick="addParty()" class="w-full mt-6 py-4 border-2 border-dashed border-slate-800 rounded-xl text-slate-500 hover:text-white hover:border-slate-600 hover:bg-slate-900 transition font-bold flex items-center justify-center gap-2 group">
                                <span class="bg-slate-800 rounded-full w-6 h-6 flex items-center justify-center text-xs group-hover:bg-slate-700 transition"><i class="fa-solid fa-plus"></i></span>
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏£‡∏£‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        window.updateVal = (i, k, v) => { state.parties[i][k] = v; saveState(state); renderUI(); };
        window.addParty = () => { state.parties.push({ id: 'p'+Date.now(), name: 'New Party', color: '#94a3b8', zone: 0, list: 0 }); saveState(state); renderUI(); };
        window.removeParty = (i) => { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏û‡∏£‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ?')) { state.parties.splice(i, 1); saveState(state); renderUI(); } };
        
        window.adj = (i, type, delta) => {
            const total = state.parties.reduce((sum, p) => sum + p[type], 0);
            const limit = LIMITS[type];
            if (delta > 0 && total >= limit) return;
            state.parties[i][type] = Math.max(0, state.parties[i][type] + delta);
            saveState(state); renderUI(); 
        };
        
        window.setScene = (s) => { state.scene = s; saveState(state); renderUI(); };
        window.setBg = (b) => { state.bg = b; saveState(state); };
        window.pushTicker = () => { 
            state.ticker = document.getElementById('ticker-input').value; 
            saveState(state); 
            const btn = document.getElementById('ticker-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
            setTimeout(() => btn.innerHTML = originalHTML, 1000);
        };

        renderUI();
    }

    // ==========================================
    // 5. ON-AIR DISPLAY (FRONTEND)
    // ==========================================
    function initOnAir() {
        document.title = "ON AIR DISPLAY";
        
        app.innerHTML = `
            <div id="main-view" class="w-full h-full flex flex-col bg-main bg-black transition-colors duration-500 relative overflow-hidden font-sans">
                <div class="scene-bg absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-30 pointer-events-none z-0"></div>
                <div class="scene-bg absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-950 to-black z-[-1]"></div>
                <div id="stage" class="absolute inset-0 z-10 flex flex-col justify-end"></div>
                <div id="error-log" class="absolute top-0 left-0 text-red-500 text-xs p-2 z-50 pointer-events-none"></div>
            </div>`;

        let currentScene = '';
        let lastSortedIDs = ''; // To detect order/rank changes

        // Clock Update
        setInterval(() => {
            const timeEl = document.getElementById('clock-text');
            if(timeEl) {
                const now = new Date();
                timeEl.innerText = now.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
            }
        }, 1000);

        // Core Render Loop
        function loop() {
            try {
                const newState = loadState();
                
                // 1. Background Check
                const view = document.getElementById('main-view');
                if(view) {
                    if(newState.bg === 'transparent') document.body.classList.add('transparent');
                    else document.body.classList.remove('transparent');
                }
                
                // 2. Data Diffing Strategy
                const stage = document.getElementById('stage');
                if(!stage) return; // Safety

                // Calculate current rank order hash
                const sorted = [...newState.parties].sort((a,b)=>(b.zone+b.list)-(a.zone+a.list));
                const currentSortedIDs = sorted.map(p => p.id).join(',');

                // Check Triggers for Re-Render (Structure Change)
                // - Scene changed
                // - Rank order changed (someone overtook another)
                const shouldFullRender = (newState.scene !== currentScene) || (currentSortedIDs !== lastSortedIDs);

                if (shouldFullRender) {
                    // Full Re-Render (Structure)
                    if(chartInstance) { chartInstance.destroy(); chartInstance = null; }
                    stage.innerHTML = ''; 
                    
                    renderSceneStructure(stage, newState);
                    
                    // Entrance Animations
                    if (newState.scene === 'newsbar') {
                        gsap.from("#news-container", { y: "100%", opacity: 0, duration: 0.8, ease: "power3.out" });
                    } else if(newState.scene === 'winner') {
                        fireConfetti();
                        gsap.from(".winner-card", { scale: 0.8, opacity: 0, duration: 1, ease: "elastic.out(1, 0.5)" });
                    } else {
                        gsap.from(".center-content", { scale: 0.95, opacity: 0, duration: 0.5, ease: "power2.out" });
                    }

                    // Update Trackers
                    currentScene = newState.scene;
                    lastSortedIDs = currentSortedIDs;
                    
                } else {
                    // Soft Update (Values/Text Only)
                    updateSceneValues(newState);
                }
                
                state = newState;
            } catch (e) {
                console.error("Render Loop Error:", e);
                const errLog = document.getElementById('error-log');
                if(errLog) errLog.innerText = "Error: " + e.message;
            }
        }

        // Force initial render immediately
        loop();
        // Start polling
        setInterval(loop, 200);
    }

    // ==========================================
    // 6. SCENE RENDERERS
    // ==========================================
    function renderSceneStructure(container, data) {
        const sorted = [...data.parties].sort((a,b)=>(b.zone+b.list)-(a.zone+a.list));
        const totalSeats = data.parties.reduce((s,p)=>s+p.zone+p.list,0);

        if(data.scene === 'newsbar') {
            container.innerHTML = `
                <div id="news-container" class="w-full relative z-50">
                    <div class="news-bar-bg h-40 flex flex-col justify-end relative overflow-hidden">
                        
                        <div class="flex-1 flex items-center px-8 gap-4 pt-2">
                            <div class="flex flex-col justify-center border-r border-white/10 pr-6 mr-2 h-20 shrink-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="bg-red-600 text-white text-[9px] font-bold px-1.5 py-0.5 rounded animate-pulse tracking-wider">LIVE</div>
                                    <div class="text-blue-400 font-bold uppercase text-[9px] tracking-widest">OFFICIAL</div>
                                </div>
                                <div id="clock-text" class="text-white font-tech font-bold text-4xl leading-none tracking-tight">00:00</div>
                                <div class="text-slate-400 text-[9px] uppercase mt-1">Real-time Count</div>
                            </div>

                            <div class="flex-1 flex gap-3 h-24 items-center overflow-hidden pr-4">
                                ${sorted.slice(0, 5).map((p, i) => `
                                    <div class="w-40 bg-[#1e293b]/60 backdrop-blur-md rounded-md p-2 border-l-4 relative overflow-hidden flex flex-col justify-center h-[90%] shadow-lg border-t border-white/5" style="border-left-color:${p.color}" id="card-${p.id}">
                                        <div class="flex justify-between items-center mb-0.5">
                                            <span class="text-[8px] text-slate-400 font-bold uppercase tracking-wider">Rank ${i+1}</span>
                                        </div>
                                        <h3 class="text-sm font-bold text-white truncate w-full mb-0 leading-tight font-tech uppercase tracking-wide party-name" id="name-${p.id}">${p.name}</h3>
                                        <div class="flex items-baseline gap-1.5 mt-0.5">
                                            <span class="text-3xl font-tech font-bold text-white num-roll leading-none" id="low-val-${p.id}" style="text-shadow:0 0 20px ${p.color}80">${p.zone+p.list}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="w-28 border-l border-white/10 pl-4 ml-2 h-20 flex flex-col justify-center text-right shrink-0">
                                 <div class="text-[9px] text-slate-400 uppercase font-bold mb-0">Total Counted</div>
                                 <div class="text-4xl font-tech font-bold text-white tracking-tighter leading-none text-yellow-500" id="total-seats-disp">${totalSeats}</div>
                                 <div class="text-[9px] text-slate-500">of 500 Seats</div>
                            </div>
                        </div>

                        <div class="h-9 bg-black/90 border-t border-white/10 flex items-center relative z-50 mt-1">
                            <div class="bg-blue-700 h-full px-4 flex items-center justify-center shrink-0 z-20 shadow-[5px_0_15px_rgba(0,0,0,0.5)]">
                                <span class="font-bold text-white tracking-widest text-[10px] uppercase">BREAKING NEWS</span>
                            </div>
                            <div class="ticker-wrap flex items-center">
                                <div id="ticker-text" class="ticker-track text-sm font-light text-slate-200">${data.ticker}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            return;
        }

        const wrapFullScreen = (content, title="ELECTION 2026") => `
            <div class="w-full h-full flex items-center justify-center p-8 center-content relative">
                <div class="absolute top-0 left-0 w-full h-24 flex justify-between items-center px-12 pt-6 z-50 obs-hide">
                    <div class="flex items-center gap-4">
                        <div class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded shadow-lg animate-pulse">LIVE BROADCAST</div>
                        <div class="text-white font-bold text-2xl tracking-widest border-l-2 border-white pl-4">${title}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-yellow-500 font-tech text-xl">OFFICIAL RESULTS</div>
                        <div class="text-slate-400 text-xs uppercase">98% Votes Counted</div>
                    </div>
                </div>
                ${content}
                <div class="absolute bottom-0 w-full h-10 bg-black/80 border-t border-slate-800 flex items-center backdrop-blur-sm">
                     <div class="bg-slate-800 px-4 h-full flex items-center text-[10px] font-bold text-slate-400 uppercase">Latest Update</div>
                     <div class="ticker-wrap w-full"><div id="ticker-text" class="ticker-track text-sm text-slate-300 pt-0.5">${data.ticker}</div></div>
                </div>
            </div>`;

        if(data.scene === 'dashboard') {
            container.innerHTML = wrapFullScreen(`
                <div class="w-full max-w-6xl mt-10">
                    <div class="grid grid-cols-1 gap-3">
                        ${sorted.map((p, i) => `
                        <div class="glass-panel p-4 rounded-xl flex items-center relative overflow-hidden group" id="dash-row-${p.id}">
                            <div class="absolute left-0 top-0 bottom-0 w-2 transition-all duration-500 group-hover:w-4 party-bar-color" style="background:${p.color}"></div>
                            <div class="w-16 font-tech text-3xl font-bold text-slate-600 text-center mr-4">#${i+1}</div>
                            <div class="flex-1 z-10">
                                <h2 class="text-2xl font-bold text-white mb-1 tracking-wide party-name-full" id="name-full-${p.id}">${p.name}</h2>
                                <div class="w-full h-2 bg-slate-800 rounded-full overflow-hidden">
                                    <div class="h-full bar-fill relative" style="width:${((p.zone+p.list)/500)*100}%; background:${p.color}" id="bar-${p.id}">
                                        <div class="absolute right-0 top-0 bottom-0 w-[2px] bg-white/50 shadow-[0_0_10px_white]"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="w-48 text-right pr-6">
                                <div class="text-5xl font-tech font-bold text-white tracking-tighter num-roll" id="val-total-${p.id}">${p.zone+p.list}</div>
                                <div class="text-[9px] text-slate-500 uppercase tracking-widest">Seats</div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>
            `, "PARLIAMENT DASHBOARD");
        }
        
        else if(data.scene === 'battle') {
            const gov = sorted[0] || {name:'-', zone:0, list:0, color:'#333'};
            const opp = sorted[1] || {name:'-', zone:0, list:0, color:'#333'};
            
            container.innerHTML = wrapFullScreen(`
                <div class="w-full max-w-5xl flex flex-col items-center mt-12">
                    <div class="flex justify-between w-full mb-4 px-2">
                         <div class="text-left">
                            <h2 class="text-4xl font-bold text-white" id="battle-name-left">${gov.name}</h2>
                            <div class="text-sm text-slate-400 uppercase tracking-widest">Current Leader</div>
                         </div>
                         <div class="text-right">
                            <h2 class="text-4xl font-bold text-white" id="battle-name-right">${opp.name}</h2>
                            <div class="text-sm text-slate-400 uppercase tracking-widest">Opposition Leader</div>
                         </div>
                    </div>
                    <div class="w-full h-32 bg-slate-900 rounded-full border-4 border-slate-800 relative flex overflow-hidden shadow-[0_0_50px_rgba(0,0,0,0.5)]">
                        <div class="h-full flex items-center justify-start pl-10 relative transition-all duration-1000" style="width:${((gov.zone+gov.list)/500)*100}%; background:${gov.color}" id="battle-left">
                             <div class="absolute right-0 top-0 bottom-0 w-20 bg-gradient-to-r from-transparent to-black/20"></div>
                        </div>
                        <div class="h-full flex items-center justify-end pr-10 relative transition-all duration-1000" style="width:${((opp.zone+opp.list)/500)*100}%; background:${opp.color}" id="battle-right">
                             <div class="absolute left-0 top-0 bottom-0 w-20 bg-gradient-to-l from-transparent to-black/20"></div>
                        </div>
                        <div class="absolute top-0 bottom-0 w-1 bg-white left-1/2 -translate-x-1/2 z-20 shadow-[0_0_20px_white]"></div>
                        <div class="absolute -top-12 left-1/2 -translate-x-1/2 bg-white text-black px-4 py-1 rounded font-bold shadow-lg text-xs tracking-widest border border-white">MAJORITY 251</div>
                    </div>
                    <div class="flex justify-between w-full mt-6">
                        <div class="text-8xl font-tech font-bold drop-shadow-2xl" style="color:${gov.color}" id="battle-txt-left">${gov.zone+gov.list}</div>
                        <div class="text-8xl font-tech font-bold drop-shadow-2xl" style="color:${opp.color}" id="battle-txt-right">${opp.zone+opp.list}</div>
                    </div>
                </div>
            `, "COALITION BATTLE");
        }

        else if(data.scene === 'parliament') {
            let dotsHtml = '';
            let idx = 0;
            let seatColors = [];
            sorted.forEach(p => { for(let i=0; i<p.zone+p.list; i++) seatColors.push(p.color); });
            
            for(let r=1; r<=12; r++) {
                const radius = 20 + (r * 3.5);
                const arcLength = Math.PI * radius;
                let dotsInRow = Math.floor(arcLength / 3);
                if(r===12) dotsInRow = 500 - idx; 
                const step = 180 / (dotsInRow + 1);
                
                for(let i=0; i<dotsInRow; i++) {
                    if(idx>=500) break;
                    const angle = (180 - (step * (i+1))) * (Math.PI / 180);
                    const x = 50 + (radius * Math.cos(angle));
                    const y = 90 - (radius * Math.sin(angle));
                    const c = seatColors[idx] || '#334155';
                    dotsHtml += `<div id="seat-${idx}" class="dot-seat absolute w-[1.1%] pb-[1.1%] rounded-full shadow-sm transition-colors duration-500" style="left:${x}%; top:${y}%; background:${c}; transform:translate(-50%,-50%); box-shadow: 0 0 2px ${c};"></div>`;
                    idx++;
                }
            }

            container.innerHTML = wrapFullScreen(`
                <div class="w-full max-w-7xl aspect-[2/1] relative scale-90 sm:scale-100 transition-transform">
                    ${dotsHtml}
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 text-center mb-0 glass-panel px-16 py-8 rounded-t-3xl border-t-4 border-white/20">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2">Projected Leader</div>
                        <h1 class="text-4xl font-bold text-white mb-2 tracking-wide">${sorted[0].name}</h1>
                        <div class="text-8xl font-tech font-bold leading-none" style="color:${sorted[0].color}; text-shadow: 0 0 30px ${sorted[0].color}50">${sorted[0].zone + sorted[0].list}</div>
                    </div>
                </div>
            `, "PARLIAMENT SEATING");
        }

        else if(data.scene === 'chart') {
            container.innerHTML = wrapFullScreen(`
                <div class="glass-panel p-12 rounded-[3rem] flex flex-col items-center justify-center relative border border-white/5 bg-slate-900/60 shadow-2xl">
                    <div class="relative w-[500px] h-[500px]">
                        <canvas id="seatsChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none flex-col">
                            <div class="text-8xl font-tech font-bold text-white">${totalSeats}</div>
                            <div class="text-slate-500 text-sm uppercase tracking-widest">Seats Filled</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-6 mt-10 w-full">
                         ${sorted.slice(0,3).map(p => `
                            <div class="flex items-center gap-3 bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                <div class="w-4 h-4 rounded-full" style="background:${p.color}"></div>
                                <div class="text-sm font-bold text-slate-200">${p.name}</div>
                                <div class="ml-auto font-tech text-xl text-white">${((p.zone+p.list)/totalSeats*100).toFixed(1)}%</div>
                            </div>
                         `).join('')}
                    </div>
                </div>
            `, "SEAT DISTRIBUTION");
            
            // Wait for DOM
            setTimeout(() => {
                const canvas = document.getElementById('seatsChart');
                if(!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const remaining = 500 - totalSeats;
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [...sorted.map(p => p.name), 'Empty'],
                        datasets: [{ 
                            data: [...sorted.map(p => p.zone+p.list), remaining], 
                            backgroundColor: [...sorted.map(p => p.color), '#1e293b'], 
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, cutout: '75%', 
                        animation: { animateScale: true, animateRotate: true },
                        plugins: { legend: { display: false }, tooltip: { enabled: false } } 
                    }
                });
            }, 100);
        }

        else if(data.scene === 'winner') {
            const w = sorted[0];
            container.innerHTML = wrapFullScreen(`
                <div class="text-center relative z-10 winner-card">
                    <div class="absolute inset-0 bg-blue-500/20 blur-[100px] rounded-full animate-pulse"></div>
                    <div class="glass-panel p-20 rounded-[3rem] border-2 border-white/20 shadow-[0_0_100px_rgba(0,0,0,0.5)] relative z-10 bg-gradient-to-b from-slate-900/90 to-black/90 backdrop-blur-3xl overflow-hidden">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div class="scanline absolute inset-0 opacity-20"></div>
                        <div class="text-7xl mb-6 drop-shadow-lg animate-bounce">üèÜ</div>
                        <div class="text-xl font-bold text-yellow-500 tracking-[0.8em] mb-6 uppercase border-b border-white/10 pb-4">Election Winner</div>
                        <h1 class="text-8xl font-bold text-white mb-6 drop-shadow-2xl tracking-tight">${w.name}</h1>
                        <div class="flex items-center justify-center gap-12 mt-8">
                            <div>
                                <div class="text-xs text-slate-500 uppercase mb-2">Total Seats</div>
                                <div class="text-9xl font-tech font-bold leading-none glow-text" style="color:${w.color}; text-shadow:0 0 40px ${w.color}">${w.zone + w.list}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `, "OFFICIAL ANNOUNCEMENT");
        }
    }

    // ==========================================
    // 7. REAL-TIME UPDATES (VALUES ONLY)
    // ==========================================
    function updateSceneValues(data) {
        const sorted = [...data.parties].sort((a,b)=>(b.zone+b.list)-(a.zone+a.list));
        
        // News Bar Update
        if(data.scene === 'newsbar') {
             const totalSeats = data.parties.reduce((s,p)=>s+p.zone+p.list,0);
             const tDisp = document.getElementById('total-seats-disp');
             if(tDisp) tDisp.innerText = totalSeats;

             data.parties.forEach(p => {
                 animateNum(`low-val-${p.id}`, p.zone + p.list);
                 // Also update name & color in case of edit
                 const nameEl = document.getElementById(`name-${p.id}`);
                 if(nameEl) nameEl.innerText = p.name;
                 const cardEl = document.getElementById(`card-${p.id}`);
                 if(cardEl) cardEl.style.borderLeftColor = p.color;
             });
             
             const tickerEl = document.getElementById('ticker-text');
             if(tickerEl && tickerEl.innerText !== data.ticker) tickerEl.innerText = data.ticker;
        }
        
        else if(data.scene === 'dashboard') {
            data.parties.forEach(p => {
                const t = p.zone + p.list;
                animateNum(`val-total-${p.id}`, t);
                const bar = document.getElementById(`bar-${p.id}`);
                if(bar) { 
                    bar.style.width = `${(t/500)*100}%`; 
                    bar.style.backgroundColor = p.color;
                }
                const nameEl = document.getElementById(`name-full-${p.id}`);
                if(nameEl) nameEl.innerText = p.name;
            });
        }
        
        else if(data.scene === 'battle') {
            const p1 = sorted[0], p2 = sorted[1];
            if(p1 && p2) {
                const t1 = p1.zone + p1.list, t2 = p2.zone + p2.list;
                const left = document.getElementById('battle-left');
                const right = document.getElementById('battle-right');
                
                if(left) { 
                    left.style.width = ((t1/500)*100)+'%'; 
                    left.style.backgroundColor = p1.color; 
                    animateNum('battle-txt-left', t1);
                    document.getElementById('battle-txt-left').style.color = p1.color;
                    document.getElementById('battle-name-left').innerText = p1.name;
                }
                if(right) { 
                    right.style.width = ((t2/500)*100)+'%'; 
                    right.style.backgroundColor = p2.color;
                    animateNum('battle-txt-right', t2);
                    document.getElementById('battle-txt-right').style.color = p2.color;
                    document.getElementById('battle-name-right').innerText = p2.name;
                }
            }
        }
    }

    function animateNum(id, newVal) {
        const el = document.getElementById(id);
        if(!el) return;
        const oldVal = parseInt(el.innerText) || 0;
        if(oldVal !== newVal) {
            gsap.to(el, { 
                innerHTML: newVal, 
                duration: 1.2, 
                snap: { innerHTML: 1 }, 
                ease: "power2.out" 
            });
        }
    }

    function fireConfetti() {
        const duration = 3000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };
        const randomInRange = (min, max) => Math.random() * (max - min) + min;

        const interval = setInterval(function() {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);
            const particleCount = 50 * (timeLeft / duration);
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
        }, 250);
    }
</script>
</body>
</html>
