<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>PO1 Election Broadcast Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;600;700&family=Chakra+Petch:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Anuphan;background:#020617;color:white;overflow:hidden}
.font-tech{font-family:Chakra Petch}
.glass{background:rgba(15,23,42,.85);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08)}
.safe-area{position:absolute;inset:10%;border:2px dashed rgba(255,255,255,.25);pointer-events:none}
</style>
</head>
<body>

<div id="app" class="w-full h-full"></div>

<script>
/* ======================================================
   CONFIG + STATE
====================================================== */
const KEY = "PO1_ENGINE_PRO";

const DEFAULT = {
  program:"lower3",
  preview:"dashboard",
  bg:"dark",
  safe:false,
  override:null,
  ticker:"‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569",
  parties:[
    {id:"p1",name:"‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô",color:"#ff9100",zone:120,list:30,bloc:"gov"},
    {id:"p2",name:"‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢",color:"#e60000",zone:100,list:25,bloc:"opp"},
    {id:"p3",name:"‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢",color:"#0033cc",zone:50,list:10,bloc:"gov"}
  ]
};

function load(){return JSON.parse(localStorage.getItem(KEY)||JSON.stringify(DEFAULT))}
function save(s){localStorage.setItem(KEY,JSON.stringify(s))}

let state = load();

/* ======================================================
   ROUTER
====================================================== */
const app=document.getElementById("app");
const mode=new URLSearchParams(location.search).get("mode");

if(mode==="control") control();
else if(mode==="onair") onair();
else menu();

/* ======================================================
   MENU
====================================================== */
function menu(){
app.innerHTML=`
<div class="h-screen flex items-center justify-center">
  <div class="glass p-12 rounded-2xl text-center">
    <h1 class="text-5xl font-tech font-bold mb-6">PO1 <span class="text-blue-500">ELECTION</span></h1>
    <div class="flex gap-6">
      <button onclick="location.href='?mode=control'" class="px-10 py-6 bg-blue-600 rounded-xl">CONTROL</button>
      <button onclick="location.href='?mode=onair'" class="px-10 py-6 bg-red-600 rounded-xl">ON AIR</button>
    </div>
  </div>
</div>`;
}

/* ======================================================
   CONTROL ROOM (DIRECTOR MODE)
====================================================== */
function control(){
document.title="PO1 Control";
render();

function render(){
app.innerHTML=`
<div class="flex h-screen">
  <div class="w-80 bg-slate-900 p-4 space-y-4">
    <h2 class="font-bold text-xl">üéõ Director</h2>

    <div>
      <div class="text-xs mb-1">PREVIEW</div>
      ${sceneBtn("preview")}
    </div>

    <button onclick="take()" class="w-full py-3 bg-red-600 font-bold rounded-xl">TAKE TO AIR</button>

    <div>
      <div class="text-xs mb-1">PROGRAM</div>
      <div class="p-2 bg-black rounded">${state.program}</div>
    </div>

    <hr class="opacity-20">

    <label class="flex items-center gap-2 text-sm">
      <input type="checkbox" ${state.safe?"checked":""} onchange="toggleSafe(this.checked)">
      Safe Area
    </label>

    <select onchange="setBg(this.value)" class="w-full bg-black p-2 rounded">
      <option value="dark">Dark</option>
      <option value="gray">Gray</option>
      <option value="transparent">Transparent</option>
    </select>

    <button onclick="override('black')" class="w-full bg-black py-2 rounded">BLACK</button>
    <button onclick="override(null)" class="w-full bg-slate-700 py-2 rounded">CLEAR</button>
  </div>

  <div class="flex-1 bg-black flex items-center justify-center text-slate-500">
    PREVIEW & PROGRAM CONTROL
  </div>
</div>`;
}

function sceneBtn(type){
return ["lower3","dashboard","parliament","battle","winner"].map(s=>
`<button onclick="setScene('${type}','${s}')"
class="w-full text-left px-4 py-2 rounded mb-1 ${state[type]===s?"bg-blue-600":"bg-slate-800"}">${s}</button>`
).join("");
}

window.setScene=(t,s)=>{state[t]=s;save(state);render()}
window.take=()=>{state.program=state.preview;save(state);render()}
window.setBg=b=>{state.bg=b;save(state)}
window.toggleSafe=v=>{state.safe=v;save(state)}
window.override=o=>{state.override=o;save(state)}
}

/* ======================================================
   ON AIR ENGINE
====================================================== */
function onair(){
document.title="PO1 ON AIR";

app.innerHTML=`
<div id="view" class="w-full h-full relative bg-black">
  <div id="stage" class="absolute inset-0"></div>
</div>`;

apply(load());

window.addEventListener("storage",e=>{
 if(e.key===KEY) apply(JSON.parse(e.newValue));
});

setInterval(()=>apply(load()),1500);
}

function apply(s){
state=s;
document.body.className="";
if(s.bg==="gray")document.body.style.background="#808080";
if(s.bg==="transparent")document.body.style.background="transparent";

const stage=document.getElementById("stage");
stage.innerHTML="";

if(s.override==="black") return;

SCENES[s.program]?.render(stage,s);

if(s.safe){
 const sa=document.createElement("div");
 sa.className="safe-area";
 stage.appendChild(sa);
}
}

/* ======================================================
   SCENE REGISTRY
====================================================== */
const SCENES={

lower3:{
render:(c,s)=>{
const sorted=[...s.parties].sort((a,b)=>(b.zone+b.list)-(a.zone+a.list));
c.innerHTML=`
<div class="absolute bottom-0 w-full glass p-6 flex gap-4">
 ${sorted.slice(0,5).map(p=>`
 <div class="flex-1 border-l-4 pl-3" style="border-color:${p.color}">
   <div class="text-sm">${p.name}</div>
   <div class="text-4xl font-tech" id="n-${p.id}">${p.zone+p.list}</div>
 </div>`).join("")}
</div>`;
sorted.forEach(p=>roll(`n-${p.id}`,p.zone+p.list));
}
},

dashboard:{
render:(c,s)=>{
c.innerHTML=`
<div class="w-full h-full flex flex-col items-center justify-center gap-4">
 ${s.parties.map(p=>`
 <div class="w-2/3 glass p-4 flex justify-between">
   <span>${p.name}</span>
   <span class="font-tech text-3xl" id="d-${p.id}">${p.zone+p.list}</span>
 </div>`).join("")}
</div>`;
s.parties.forEach(p=>roll(`d-${p.id}`,p.zone+p.list));
}
},

parliament:{
render:(c,s)=>{
const total=s.parties.reduce((t,p)=>t+p.zone+p.list,0);
c.innerHTML=`
<div class="h-full flex items-center justify-center">
 <div class="glass p-16 text-center">
  <div class="text-7xl font-tech">${total}</div>
  <div class="text-sm text-slate-400">TOTAL SEATS</div>
 </div>
</div>`;
}
},

battle:{
render:(c,s)=>{
const gov=sum(s.parties.filter(p=>p.bloc==="gov"));
const opp=sum(s.parties.filter(p=>p.bloc==="opp"));
c.innerHTML=`
<div class="h-full flex items-center justify-center">
 <div class="w-3/4 h-24 flex rounded-full overflow-hidden">
  <div class="bg-blue-600 flex items-center pl-6" style="width:${gov/5}%">GOV ${gov}</div>
  <div class="bg-red-600 flex items-center justify-end pr-6" style="width:${opp/5}%">OPP ${opp}</div>
 </div>
</div>`;
}
},

winner:{
render:(c,s)=>{
const w=[...s.parties].sort((a,b)=>(b.zone+b.list)-(a.zone+a.list))[0];
c.innerHTML=`
<div class="h-full flex items-center justify-center">
 <div class="glass p-24 text-center">
  <div class="text-8xl mb-6">üèÜ</div>
  <h1 class="text-6xl">${w.name}</h1>
  <div class="text-[8rem] font-tech" style="color:${w.color}">${w.zone+w.list}</div>
 </div>
</div>`;
}
}

};

/* ======================================================
   UTILS
====================================================== */
function roll(id,val){
const el=document.getElementById(id);
if(!el) return;
gsap.to(el,{innerHTML:val,duration:1.2,snap:{innerHTML:1},ease:"power3.out"});
}
function sum(arr){return arr.reduce((t,p)=>t+p.zone+p.list,0)}
</script>
</body>
</html>
