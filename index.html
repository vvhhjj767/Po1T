import React, { useState, useEffect, useMemo } from 'react';
import { 
  Users, PieChart, BarChart3, LayoutGrid, Type, MonitorPlay, 
  Settings2, Plus, Minus, AlertTriangle, CheckCircle2 
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { PieChart as RePie, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts';

// --- TYPES & CONSTANTS ---
const MAX_SEATS = 500;
const MAX_CONST = 400;
const MAX_PARTY = 100;

type SceneType = 'TABLE' | 'HEMICYCLE' | 'TOP3' | 'DONUT' | 'GRID';

interface Party {
  id: string;
  name: string;
  color: string;
  constituency: number;
  partyList: number;
}

interface AppState {
  parties: Party[];
  activeScene: SceneType;
  tickerText: string;
  isTickerVisible: boolean;
}

// Initial Data Seed
const INITIAL_STATE: AppState = {
  parties: [
    { id: '1', name: 'Peopleâ€™s Vision', color: '#F97316', constituency: 140, partyList: 25 },
    { id: '2', name: 'National Pride', color: '#1D4ED8', constituency: 110, partyList: 20 },
    { id: '3', name: 'Liberal Union', color: '#DC2626', constituency: 60, partyList: 15 },
    { id: '4', name: 'Green Future', color: '#16A34A', constituency: 30, partyList: 5 },
    { id: '5', name: 'Democratic Front', color: '#9333EA', constituency: 10, partyList: 2 },
  ],
  activeScene: 'HEMICYCLE',
  tickerText: 'BREAKING NEWS: ELECTION RESULTS STARTING TO COME IN - VOTER TURNOUT ESTIMATED AT 75% - LIVE UPDATES...',
  isTickerVisible: true,
};

// --- UTILS ---
const getTotal = (p: Party) => p.constituency + p.partyList;
const getAllocatedSeats = (parties: Party[]) => parties.reduce((sum, p) => sum + getTotal(p), 0);
const formatNumber = (num: number) => num.toLocaleString();

// --- COMPONENTS: ON-AIR VISUALS ---

// 1. Score Table
const SceneTable = ({ parties }: { parties: Party[] }) => {
  const sorted = [...parties].sort((a, b) => getTotal(b) - getTotal(a));
  
  return (
    <div className="w-full max-w-4xl mx-auto mt-10">
      <div className="bg-slate-900/80 backdrop-blur-md rounded-xl border border-slate-700 overflow-hidden shadow-2xl">
        <div className="grid grid-cols-12 bg-slate-800 p-4 font-bold text-slate-300 text-lg uppercase tracking-wider">
          <div className="col-span-1">Rank</div>
          <div className="col-span-5">Party</div>
          <div className="col-span-2 text-center">Const.</div>
          <div className="col-span-2 text-center">P-List</div>
          <div className="col-span-2 text-right">Total</div>
        </div>
        <AnimatePresence>
          {sorted.map((p, index) => (
            <motion.div 
              key={p.id}
              layout
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="grid grid-cols-12 p-4 border-b border-slate-800 items-center text-2xl font-bold"
            >
              <div className="col-span-1 text-slate-500">#{index + 1}</div>
              <div className="col-span-5 flex items-center gap-3">
                <div className="w-6 h-6 rounded-full shadow-lg" style={{ backgroundColor: p.color }} />
                <span className="text-white">{p.name}</span>
              </div>
              <div className="col-span-2 text-center text-slate-400 font-mono">{p.constituency}</div>
              <div className="col-span-2 text-center text-slate-400 font-mono">{p.partyList}</div>
              <div className="col-span-2 text-right text-4xl text-white font-mono" style={{ color: p.color }}>
                {getTotal(p)}
              </div>
            </motion.div>
          ))}
        </AnimatePresence>
      </div>
    </div>
  );
};

// 2. Hemicycle (Parliament Arch)
const SceneHemicycle = ({ parties }: { parties: Party[] }) => {
  // Sort for "Winner Center" visual or standard block? Let's do Standard Block by size for visual clarity
  const sorted = [...parties].sort((a, b) => getTotal(b) - getTotal(a));
  
  // Create an array of 500 dots
  const totalSeats = 500;
  const dots = [];
  
  // Flatten seat allocation
  let seatMap: string[] = [];
  sorted.forEach(p => {
    const count = getTotal(p);
    for(let i=0; i<count; i++) seatMap.push(p.color);
  });
  // Fill rest with grey
  while(seatMap.length < totalSeats) seatMap.push('#334155');

  // Math for Arch
  const rows = 12;
  const seatsPerRow = [25, 30, 35, 38, 42, 45, 48, 50, 52, 55, 50, 30]; // Approximate distribution
  // Or simpler: Polar coordinates loop
  
  // Let's use a simpler flex grid styled as an arch or pure CSS art
  // For robustness, we render dots in absolute position using polar coords
  
  const generateHemicycle = () => {
    const output = [];
    const R = 400; // Radius
    let currentSeatIndex = 0;

    for (let r = 0; r < 10; r++) { // 10 rows
      const rowRadius = 150 + (r * 35);
      const circumference = Math.PI * rowRadius;
      const seatsInRow = Math.floor(circumference / 18); // 18px gap per seat
      const angleStep = Math.PI / (seatsInRow - 1);

      for (let s = 0; s < seatsInRow; s++) {
        if (currentSeatIndex >= 500) break;
        
        const angle = Math.PI - (s * angleStep); // Start from 180 (left) to 0 (right)
        const x = rowRadius * Math.cos(angle);
        const y = rowRadius * Math.sin(angle);
        
        output.push(
          <motion.div
            key={currentSeatIndex}
            initial={{ scale: 0 }}
            animate={{ scale: 1, backgroundColor: seatMap[currentSeatIndex] || '#334155' }}
            transition={{ delay: currentSeatIndex * 0.001 }} // Stagger animation
            className="absolute w-3 h-3 rounded-full shadow-sm"
            style={{
              left: `calc(50% + ${x}px)`,
              bottom: `${y}px`,
              transform: 'translate(-50%, 50%)'
            }}
          />
        );
        currentSeatIndex++;
      }
    }
    return output;
  };

  return (
    <div className="relative w-full h-[600px] flex items-end justify-center overflow-hidden">
      <div className="absolute bottom-0 w-full h-[500px]">
         {generateHemicycle()}
      </div>
      <div className="absolute bottom-10 text-center z-10">
        <h2 className="text-xl text-slate-400 uppercase tracking-[0.2em] mb-2">Total Seats Filled</h2>
        <div className="text-8xl font-black text-white tracking-tighter">
          {getAllocatedSeats(parties)}<span className="text-4xl text-slate-600">/500</span>
        </div>
      </div>
    </div>
  );
};

// 3. Top 3 Spotlight
const SceneTop3 = ({ parties }: { parties: Party[] }) => {
  const top3 = [...parties].sort((a, b) => getTotal(b) - getTotal(a)).slice(0, 3);

  return (
    <div className="flex items-center justify-center gap-8 h-full px-10">
      {top3.map((p, idx) => {
        const isFirst = idx === 0;
        return (
          <motion.div 
            key={p.id}
            initial={{ opacity: 0, y: 50 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: idx * 0.2 }}
            className={`relative rounded-2xl p-8 flex flex-col items-center justify-between shadow-2xl border-t-4
              ${isFirst ? 'w-96 h-[500px] bg-slate-800 z-10 scale-110 border-yellow-400' : 'w-80 h-[400px] bg-slate-900 border-slate-700 opacity-90'}
            `}
            style={{ borderColor: p.color }}
          >
             {isFirst && <div className="absolute -top-6 bg-yellow-500 text-black font-black px-4 py-1 rounded shadow-lg uppercase tracking-wider">Current Leader</div>}
             
             <div className="text-center mt-4">
               <div className="text-8xl font-black text-white mb-2" style={{ color: p.color }}>{getTotal(p)}</div>
               <div className="text-slate-400 uppercase tracking-widest text-sm">Seats Secured</div>
             </div>

             <div className="w-full text-center">
                <div className="w-20 h-20 mx-auto rounded-full mb-4 shadow-xl" style={{ backgroundColor: p.color }} />
                <h3 className="text-3xl font-bold text-white leading-tight">{p.name}</h3>
             </div>

             <div className="w-full grid grid-cols-2 gap-2 text-sm text-slate-400 bg-black/20 p-3 rounded-lg">
                <div className="text-center border-r border-slate-700">
                  <div className="font-bold text-white">{p.constituency}</div>
                  <div>District</div>
                </div>
                <div className="text-center">
                  <div className="font-bold text-white">{p.partyList}</div>
                  <div>P-List</div>
                </div>
             </div>
          </motion.div>
        );
      })}
    </div>
  );
};

// 4. Donut Chart
const SceneDonut = ({ parties }: { parties: Party[] }) => {
  const data = parties.map(p => ({ name: p.name, value: getTotal(p), color: p.color }));
  // Add empty seats
  const allocated = getAllocatedSeats(parties);
  if (allocated < 500) {
    data.push({ name: 'Unfilled', value: 500 - allocated, color: '#334155' });
  }

  return (
    <div className="flex items-center justify-center h-full w-full">
      <div className="relative w-[600px] h-[600px]">
        <ResponsiveContainer width="100%" height="100%">
          <RePie
            data={data}
            innerRadius={180}
            outerRadius={280}
            paddingAngle={2}
            dataKey="value"
            stroke="none"
          >
            {data.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={entry.color} />
            ))}
          </RePie>
        </ResponsiveContainer>
        <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <span className="text-9xl font-black text-white">{allocated}</span>
            <span className="text-2xl text-slate-400 uppercase tracking-[0.3em]">Total Seats</span>
        </div>
      </div>
      {/* Legend */}
      <div className="ml-10 space-y-4">
        {parties.sort((a,b) => getTotal(b) - getTotal(a)).map(p => (
           <div key={p.id} className="flex items-center gap-3">
              <div className="w-6 h-6 rounded bg-slate-800" style={{ backgroundColor: p.color }}></div>
              <div className="text-2xl font-bold text-white w-20 text-right">{getTotal(p)}</div>
              <div className="text-xl text-slate-300">{p.name}</div>
           </div>
        ))}
      </div>
    </div>
  );
};

// 5. Grid View
const SceneGrid = ({ parties }: { parties: Party[] }) => {
   const sorted = [...parties].sort((a, b) => getTotal(b) - getTotal(a));
   let seatMap: string[] = [];
   sorted.forEach(p => {
     for(let i=0; i<getTotal(p); i++) seatMap.push(p.color);
   });
   while(seatMap.length < 500) seatMap.push('#1e293b'); // Dark slate for empty

   return (
     <div className="w-full max-w-6xl mx-auto h-full flex flex-col justify-center">
        <h2 className="text-3xl font-bold text-white mb-6 uppercase tracking-wider border-l-8 border-white pl-4">Seat Allocation Map</h2>
        <div className="flex flex-wrap gap-1">
          {seatMap.map((color, i) => (
            <motion.div 
              key={i}
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: i * 0.0005 }}
              className="w-5 h-5 rounded-sm"
              style={{ backgroundColor: color }}
            />
          ))}
        </div>
        <div className="mt-4 flex justify-between text-slate-400 font-mono">
           <span>MAJORITY THRESHOLD: 251</span>
           <span>TOTAL: 500</span>
        </div>
        {/* Majority Line Indicator logic is visual only here for grid */}
     </div>
   );
};

// --- CORE: ON-AIR RENDERER ---
const OnAirDisplay = () => {
  const [state, setState] = useState<AppState>(INITIAL_STATE);

  useEffect(() => {
    const bc = new BroadcastChannel('election-network');
    bc.onmessage = (event) => setState(event.data);
    return () => bc.close();
  }, []);

  const renderScene = () => {
    switch (state.activeScene) {
      case 'TABLE': return <SceneTable parties={state.parties} />;
      case 'HEMICYCLE': return <SceneHemicycle parties={state.parties} />;
      case 'TOP3': return <SceneTop3 parties={state.parties} />;
      case 'DONUT': return <SceneDonut parties={state.parties} />;
      case 'GRID': return <SceneGrid parties={state.parties} />;
      default: return <SceneTable parties={state.parties} />;
    }
  };

  return (
    <div className="w-screen h-screen bg-slate-950 text-white overflow-hidden flex flex-col relative font-sans">
       {/* Top Bar for Branding */}
       <div className="h-16 bg-gradient-to-r from-blue-900 to-slate-900 flex items-center px-8 border-b border-slate-700 shadow-xl z-20">
          <div className="bg-red-600 text-white font-black px-3 py-1 text-lg rounded-sm mr-4 animate-pulse">LIVE</div>
          <div className="text-2xl font-bold tracking-tight">ELECTION 2026 <span className="text-slate-400 font-normal">OFFICIAL COUNT</span></div>
       </div>

       {/* Main Content Area */}
       <div className="flex-1 relative flex items-center justify-center p-8 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
          {/* Background Gradient Mesh */}
          <div className="absolute inset-0 bg-gradient-to-br from-blue-900/20 via-slate-900/50 to-slate-900 z-0 pointer-events-none" />
          
          <div className="w-full h-full relative z-10 flex items-center justify-center">
            {renderScene()}
          </div>
       </div>

       {/* Ticker */}
       <AnimatePresence>
         {state.isTickerVisible && (
           <motion.div 
            initial={{ y: 100 }} animate={{ y: 0 }} exit={{ y: 100 }}
            className="h-14 bg-yellow-400 text-black flex items-center overflow-hidden border-t-4 border-black z-30"
           >
             <div className="bg-black text-yellow-400 font-black px-6 h-full flex items-center text-xl uppercase z-10 shadow-xl">
               Breaking News
             </div>
             <div className="whitespace-nowrap flex-1 overflow-hidden relative">
               <motion.div 
                 animate={{ x: ["100%", "-100%"] }} 
                 transition={{ repeat: Infinity, duration: 20, ease: "linear" }}
                 className="absolute top-0 bottom-0 flex items-center text-2xl font-bold uppercase"
               >
                 {state.tickerText}
               </motion.div>
             </div>
           </motion.div>
         )}
       </AnimatePresence>
    </div>
  );
};

// --- CORE: DIRECTOR CONTROLLER ---
const DirectorControl = () => {
  const [state, setState] = useState<AppState>(INITIAL_STATE);
  const bc = useMemo(() => new BroadcastChannel('election-network'), []);

  // Sync out
  useEffect(() => {
    bc.postMessage(state);
  }, [state, bc]);

  const updateParty = (id: string, field: keyof Party, value: any) => {
    setState(prev => {
      const updatedParties = prev.parties.map(p => {
        if (p.id !== id) return p;
        const newP = { ...p, [field]: value };
        // Validation Logic
        if (field === 'constituency' || field === 'partyList') {
           const currentTotal = getAllocatedSeats(prev.parties) - getTotal(p) + getTotal(newP);
           if (currentTotal > MAX_SEATS) return p; // Block overflow
           if (field === 'constituency' && value > MAX_CONST) return p;
           if (field === 'partyList' && value > MAX_PARTY) return p;
        }
        return newP;
      });
      return { ...prev, parties: updatedParties };
    });
  };

  const totalAllocated = getAllocatedSeats(state.parties);
  const seatsRemaining = MAX_SEATS - totalAllocated;

  return (
    <div className="w-screen h-screen bg-zinc-900 text-zinc-100 flex overflow-hidden font-sans">
      {/* Sidebar - Party Management */}
      <div className="w-1/3 border-r border-zinc-700 flex flex-col bg-zinc-800">
        <div className="p-4 border-b border-zinc-700 bg-zinc-900 flex justify-between items-center">
           <h2 className="font-bold flex items-center gap-2"><Settings2 size={20} /> PARTY MANAGER</h2>
           <div className={`px-3 py-1 rounded font-mono text-sm ${seatsRemaining < 0 ? 'bg-red-600' : 'bg-emerald-600'}`}>
              Rem: {seatsRemaining}
           </div>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
           {state.parties.map(p => (
             <div key={p.id} className="bg-zinc-700/50 p-4 rounded-lg border border-zinc-600 hover:border-zinc-500 transition-colors">
               <div className="flex justify-between items-center mb-3">
                 <input 
                   value={p.name} 
                   onChange={(e) => updateParty(p.id, 'name', e.target.value)}
                   className="bg-transparent font-bold text-lg border-b border-transparent focus:border-blue-500 outline-none w-2/3"
                 />
                 <input 
                   type="color" 
                   value={p.color} 
                   onChange={(e) => updateParty(p.id, 'color', e.target.value)}
                   className="w-8 h-8 rounded cursor-pointer bg-transparent"
                 />
               </div>
               
               <div className="grid grid-cols-2 gap-4">
                 {/* Constituency Controls */}
                 <div className="bg-zinc-900/50 p-2 rounded">
                   <div className="text-xs text-zinc-400 mb-1 uppercase">District (Max 400)</div>
                   <div className="flex items-center justify-between">
                     <button onClick={() => updateParty(p.id, 'constituency', Math.max(0, p.constituency - 1))} className="p-1 hover:bg-zinc-700 rounded"><Minus size={16}/></button>
                     <span className="font-mono text-xl font-bold">{p.constituency}</span>
                     <button onClick={() => updateParty(p.id, 'constituency', p.constituency + 1)} className="p-1 hover:bg-blue-600 bg-blue-700 rounded"><Plus size={16}/></button>
                   </div>
                 </div>
                 {/* Party List Controls */}
                 <div className="bg-zinc-900/50 p-2 rounded">
                   <div className="text-xs text-zinc-400 mb-1 uppercase">P-List (Max 100)</div>
                   <div className="flex items-center justify-between">
                     <button onClick={() => updateParty(p.id, 'partyList', Math.max(0, p.partyList - 1))} className="p-1 hover:bg-zinc-700 rounded"><Minus size={16}/></button>
                     <span className="font-mono text-xl font-bold">{p.partyList}</span>
                     <button onClick={() => updateParty(p.id, 'partyList', p.partyList + 1)} className="p-1 hover:bg-purple-600 bg-purple-700 rounded"><Plus size={16}/></button>
                   </div>
                 </div>
               </div>
               <div className="mt-2 text-right text-sm text-zinc-400">
                  Total: <span className="text-white font-bold">{getTotal(p)}</span>
               </div>
             </div>
           ))}
        </div>
      </div>

      {/* Main Control Area */}
      <div className="flex-1 flex flex-col bg-zinc-900">
         {/* Scene Selector */}
         <div className="p-8">
            <h2 className="text-zinc-400 uppercase tracking-widest text-sm mb-4 font-bold">Live Scene Selection</h2>
            <div className="grid grid-cols-5 gap-4">
               {[
                 { id: 'TABLE', icon: LayoutGrid, label: 'Table' },
                 { id: 'HEMICYCLE', icon: Users, label: 'Hemicycle' },
                 { id: 'TOP3', icon: BarChart3, label: 'Top 3' },
                 { id: 'DONUT', icon: PieChart, label: 'Donut' },
                 { id: 'GRID', icon: LayoutGrid, label: 'Full Grid' },
               ].map((scene) => (
                 <button
                   key={scene.id}
                   onClick={() => setState(s => ({ ...s, activeScene: scene.id as SceneType }))}
                   className={`
                     h-32 rounded-xl flex flex-col items-center justify-center gap-3 transition-all border-2
                     ${state.activeScene === scene.id 
                       ? 'bg-red-600 border-red-400 shadow-[0_0_20px_rgba(220,38,38,0.5)] scale-105' 
                       : 'bg-zinc-800 border-zinc-700 hover:bg-zinc-700 hover:border-zinc-500'}
                   `}
                 >
                    <scene.icon size={32} />
                    <span className="font-bold uppercase">{scene.label}</span>
                    {state.activeScene === scene.id && <span className="flex items-center gap-1 text-xs animate-pulse"><MonitorPlay size={12}/> LIVE</span>}
                 </button>
               ))}
            </div>
         </div>

         {/* Ticker Control */}
         <div className="mt-auto p-8 border-t border-zinc-800 bg-zinc-800/30">
            <h2 className="text-zinc-400 uppercase tracking-widest text-sm mb-4 font-bold flex items-center gap-2"><Type size={16} /> Breaking News Ticker</h2>
            <div className="flex gap-4">
               <input 
                 value={state.tickerText}
                 onChange={(e) => setState(s => ({ ...s, tickerText: e.target.value }))}
                 className="flex-1 bg-zinc-950 border border-zinc-700 p-4 rounded text-lg focus:border-yellow-500 outline-none"
               />
               <button 
                 onClick={() => setState(s => ({ ...s, isTickerVisible: !s.isTickerVisible }))}
                 className={`w-32 rounded font-bold uppercase transition-colors ${state.isTickerVisible ? 'bg-green-600 hover:bg-green-500' : 'bg-red-900/50 hover:bg-red-900 text-zinc-400'}`}
               >
                 {state.isTickerVisible ? 'ON AIR' : 'HIDDEN'}
               </button>
            </div>
         </div>
      </div>
    </div>
  );
};

// --- LAUNCHER ---
export default function App() {
  const [mode, setMode] = useState<'launcher' | 'director' | 'onair'>('launcher');

  if (mode === 'director') return <DirectorControl />;
  if (mode === 'onair') return <OnAirDisplay />;

  return (
    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-white p-4">
      <div className="max-w-2xl w-full text-center space-y-8">
        <h1 className="text-5xl font-black bg-gradient-to-r from-blue-400 to-red-400 bg-clip-text text-transparent">
          Election Broadcast System
        </h1>
        <p className="text-slate-400 text-lg">
          Real-time dual-screen graphics engine. Open the Director in this tab, 
          and the On-Air screen in a new window (connected to OBS/Stream).
        </p>
        
        <div className="grid grid-cols-2 gap-8 mt-12">
           <button 
             onClick={() => setMode('director')}
             className="group bg-slate-800 hover:bg-slate-700 border border-slate-600 p-8 rounded-2xl flex flex-col items-center gap-4 transition-all hover:scale-105"
           >
             <Settings2 size={48} className="text-blue-400 group-hover:text-blue-300" />
             <div className="text-xl font-bold">Director Control</div>
             <div className="text-sm text-slate-500">Back office controls</div>
           </button>

           <button 
             onClick={() => window.open(window.location.href + '?mode=onair', '_blank')}
             // Note: In a real app, we'd handle routing better. For this single-file demo, 
             // user just clicks this to open new tab, but needs to manually select "On Air" 
             // in the new tab if URL params aren't handled.
             // Simpler approach for demo:
             className="group bg-slate-800 hover:bg-slate-700 border border-slate-600 p-8 rounded-2xl flex flex-col items-center gap-4 transition-all hover:scale-105"
             onMouseDown={() => {
                // Hint for the user
             }}
           >
             <MonitorPlay size={48} className="text-red-500 group-hover:text-red-400" />
             <div className="text-xl font-bold">On-Air Screen</div>
             <div className="text-sm text-slate-500">Open in New Tab</div>
           </button>
        </div>
        
        <div className="mt-8 text-sm text-slate-600 font-mono">
           Tip: After opening the new tab, click "On Air" button in that new tab if the router is not configured.
        </div>
         {/* Helper for the single-file demo to switch modes if manual click needed */}
         <div className="flex gap-4 justify-center pt-10 opacity-50">
            <button onClick={() => setMode('onair')} className="text-xs border px-2 py-1 rounded">Debug: Switch to OnAir Here</button>
         </div>
      </div>
    </div>
  );
}
